<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUPPET STRINGS | STRATEGIC OVERLORD v11.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;500;700&family=Orbitron:wght@400;700;900&display=swap');
        :root { --primary: #00f2ff; --danger: #ff0055; --bg: #020408; --panel-bg: rgba(4, 8, 15, 0.98); }
        
        body { 
            background: var(--bg); 
            color: var(--primary); 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Fira Code', monospace; 
            text-transform: uppercase; 
            background-image: radial-gradient(circle at 50% 50%, #0a1428 0%, #020408 100%); 
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        /* Scrollbar Styling */
        #oracle-response-box::-webkit-scrollbar, .custom-scroll::-webkit-scrollbar { width: 4px; }
        #oracle-response-box::-webkit-scrollbar-track, .custom-scroll::-webkit-scrollbar-track { background: rgba(0, 242, 255, 0.05); }
        #oracle-response-box::-webkit-scrollbar-thumb, .custom-scroll::-webkit-scrollbar-thumb { background: var(--primary); }

        .map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        .country { fill: #0d1a2d; stroke: rgba(0, 242, 255, 0.15); stroke-width: 0.6; transition: all 0.3s ease; cursor: crosshair; }
        .country:hover { fill: #1e3a5f; stroke: var(--primary); }
        .country.active { fill: rgba(0, 242, 255, 0.25); stroke: var(--primary); stroke-width: 1.5; filter: drop-shadow(0 0 10px var(--primary)); }
        
        .terminal-border { border: 1px solid rgba(0, 242, 255, 0.3); background: rgba(0, 10, 20, 0.8); backdrop-filter: blur(8px); }
        
        #info-panel { 
            background: var(--panel-bg); 
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1); 
            transform: translateX(100%); 
            border-left: 1px solid rgba(0, 242, 255, 0.2); 
            z-index: 100; 
            position: fixed; 
            right: 0; 
            top: 0; 
            height: 100%; 
            width: 600px; 
            box-shadow: -20px 0 50px rgba(0,0,0,0.8);
        }
        #info-panel.visible { transform: translateX(0); }
        
        .stat-card { border: 1px solid rgba(0, 242, 255, 0.1); background: rgba(255,255,255,0.02); padding: 16px; transition: background 0.3s; }
        .stat-card:hover { background: rgba(0, 242, 255, 0.05); }

        .signal-item { border-left: 2px solid var(--primary); padding-left: 12px; margin-bottom: 6px; animation: fadeIn 0.5s ease; background: rgba(0, 242, 255, 0.02); padding-top: 4px; padding-bottom: 4px; }
        
        .ai-msg { color: #fff; line-height: 1.6; }
        .user-cmd { color: var(--primary); opacity: 0.5; font-size: 10px; margin-top: 12px; margin-bottom: 4px; display: block; }

        /* Rapport Tactique Structuré */
        .tactical-report {
            border: 1px solid rgba(0, 242, 255, 0.2);
            padding: 24px;
            background: rgba(0, 0, 0, 0.3);
        }
        .report-header {
            border-bottom: 1px solid rgba(0, 242, 255, 0.5);
            padding-bottom: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .report-label {
            font-size: 10px;
            letter-spacing: 0.2em;
            color: var(--primary);
            font-weight: 700;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            display: inline-block;
            margin-right: 6px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="loader" class="fixed inset-0 bg-black z-[1000] flex flex-col items-center justify-center">
        <div class="orbitron text-4xl font-black mb-8 text-cyan-500 animate-pulse">SYSTEM_BOOT</div>
        <div class="w-96 h-[1px] bg-gray-900"><div id="loader-bar" class="h-full bg-cyan-400 w-0 transition-all duration-700"></div></div>
    </div>

    <div id="map" class="map-container"></div>

    <!-- HUD PRINCIPAL -->
    <div class="fixed inset-0 pointer-events-none z-50 p-10 flex flex-col justify-between">
        <div class="flex justify-between items-start">
            <div class="terminal-border p-8 pointer-events-auto">
                <h1 class="orbitron text-2xl font-black tracking-[0.2em]">OVERLORD_V11.5</h1>
                <div class="text-[9px] mt-1 text-cyan-400 opacity-50 font-bold">SECURE NETWORK // NODAL ACCESS</div>
            </div>
            <div id="clock" class="terminal-border p-5 orbitron text-xl font-medium pointer-events-auto tabular-nums">00:00:00</div>
        </div>
        
        <div class="pointer-events-auto">
            <div class="terminal-border p-6 w-[500px] h-48 flex flex-col">
                <div class="text-[10px] font-bold border-b border-white/10 pb-2 mb-3 tracking-widest flex justify-between">
                    <span>GLOBAL_SITUATIONAL_AWARENESS</span>
                    <span class="text-cyan-500 italic">LIVE_FEED</span>
                </div>
                <div id="log-feed" class="flex-1 overflow-hidden text-[10px] space-y-3 italic opacity-80">
                    <div class="animate-pulse">WAITING FOR SATELLITE HANDSHAKE...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PANNEAU D'ANALYSE -->
    <div id="info-panel" class="flex flex-col">
        <div class="p-12 flex-1 overflow-y-auto custom-scroll">
            <div class="flex justify-between items-start mb-12">
                <div class="flex flex-col">
                    <span class="text-[10px] text-cyan-500 mb-2 tracking-[0.5em] font-bold opacity-60">GEOPOLITICAL_VECTOR</span>
                    <h2 id="country-name" class="orbitron text-5xl font-black text-white tracking-tighter uppercase">--</h2>
                </div>
                <button onclick="hidePanel()" class="text-xl hover:text-white transition-colors opacity-30 hover:opacity-100 p-2">✕</button>
            </div>

            <!-- GRILLE DE DONNÉES -->
            <div id="stats-grid" class="grid grid-cols-2 gap-4 mb-10"></div>

            <!-- RAPPORT TACTIQUE STRUCTURE -->
            <div class="tactical-report">
                <div class="report-header">
                    <div class="report-label uppercase">Synthesis_Briefing</div>
                    <div class="text-[9px] font-mono opacity-40">INSTID: 882-STRAT</div>
                </div>
                
                <div id="report-text" class="text-[13px] leading-relaxed text-gray-400 font-mono tracking-tight">
                    <div class="flex items-center gap-3">
                        <div class="status-dot animate-pulse"></div>
                        <span class="opacity-40">SYSTEM READY. SELECT TARGET ON GRID.</span>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-white/5 flex justify-between items-center opacity-30 text-[9px] font-mono">
                    <div class="flex gap-4">
                        <span>DATA_STABILITY: 98.4%</span>
                        <span>LINK_STRENGHT: OPTIMAL</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONSOLE S.Y.B.I.L -->
        <div class="p-8 border-t border-white/10 bg-black/40 backdrop-blur-md">
            <div class="flex items-center justify-between mb-4 px-1">
                <div class="flex items-center gap-3">
                    <div class="w-1.5 h-1.5 bg-cyan-500 rounded-full shadow-[0_0_8px_var(--primary)]"></div>
                    <span class="text-[10px] font-bold tracking-[0.4em] text-cyan-500">S.Y.B.I.L_NODE</span>
                </div>
                <span class="text-[9px] font-mono opacity-30">ENCRYPTED_COMMS</span>
            </div>
            
            <div id="oracle-response-box" class="h-40 overflow-y-auto mb-5 p-5 bg-black/60 border border-white/5 text-[12px] scroll-smooth font-mono">
                <div class="ai-msg italic opacity-50">S.Y.B.I.L. ONLINE. WAITING FOR DIRECTIVE...</div>
            </div>

            <div class="relative flex items-center">
                <span class="absolute left-5 text-cyan-500 font-bold text-xs opacity-50">></span>
                <input type="text" id="oracle-input" autocomplete="off" placeholder="INPUT COMMAND..." class="w-full pl-12 p-4 bg-white/5 border border-white/10 focus:border-cyan-500 focus:bg-white/10 outline-none text-[11px] font-mono transition-all" onkeypress="handleOracleKey(event)">
            </div>
        </div>
    </div>

    <script>
        let svg, g, projection, path;
        
        async function init() {
            const bar = document.getElementById('loader-bar');
            bar.style.width = "40%";
            initMap();
            fetchGDELT();
            setInterval(fetchGDELT, 60000);
            bar.style.width = "100%";
            setTimeout(() => document.getElementById('loader').style.display = 'none', 800);
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString('fr-FR', { hour12: false });
            }, 1000);
        }

        async function fetchGDELT() {
            const feed = document.getElementById('log-feed');
            try {
                const res = await fetch(`https://api.gdeltproject.org/api/v2/doc/doc?query=(conflict OR economy OR crisis)&mode=artlist&format=json&maxrecords=5`);
                const data = await res.json();
                if (data.articles) {
                    feed.innerHTML = data.articles.map(a => `<div class="signal-item"> ${a.title.toUpperCase()}</div>`).join('');
                }
            } catch (e) {
                feed.innerHTML = `<div class="text-red-900 text-[10px] font-bold tracking-widest">SIGNAL_ERROR // RETRYING_HANDSHAKE...</div>`;
            }
        }

        function initMap() {
            const w = window.innerWidth, h = window.innerHeight;
            svg = d3.select("#map").append("svg").attr("width", w).attr("height", h);
            g = svg.append("g");
            projection = d3.geoMercator().scale(w / 6.5).translate([w / 2.5, h / 1.5]);
            path = d3.geoPath().projection(projection);
            d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson").then(topo => {
                g.selectAll("path").data(topo.features).enter().append("path").attr("d", path).attr("class", "country")
                .on("click", (e, d) => analyzeCountry(d.properties.name, e.target));
            });
            svg.call(d3.zoom().scaleExtent([1, 15]).on("zoom", (ev) => g.attr("transform", ev.transform)));
        }

        async function analyzeCountry(name, el) {
            d3.selectAll(".country").classed("active", false);
            d3.select(el).classed("active", true);
            document.getElementById('info-panel').classList.add('visible');
            document.getElementById('country-name').innerText = name;
            
            document.getElementById('stats-grid').innerHTML = '<div class="col-span-2 text-[10px] tracking-[0.2em] opacity-30 italic">INITIALIZING_QUERY...</div>';
            document.getElementById('report-text').innerHTML = '<div class="flex items-center gap-3"><div class="status-dot animate-ping"></div><span class="opacity-30">PULLING STRATEGIC ASSETS...</span></div>';

            try {
                const res = await fetch('/api', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ country: name })
                });
                const data = await res.json();
                
                document.getElementById('stats-grid').innerHTML = `
                    <div class="stat-card">
                        <div class="text-[9px] text-cyan-500/60 mb-2 font-bold">POWER_PROJECTION</div>
                        <div class="text-2xl font-black orbitron tabular-nums">${data.stats?.power || '0'}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-[9px] text-cyan-500/60 mb-2 font-bold">THREAT_LEVEL</div>
                        <div class="text-2xl font-black orbitron tabular-nums text-red-500">${data.stats?.threat || '0'}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-[9px] text-cyan-500/60 mb-2 font-bold">DOMINO_RISK</div>
                        <div class="text-2xl font-black orbitron tabular-nums text-yellow-500">${data.stats?.domino || '0'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-[9px] text-cyan-500/60 mb-2 font-bold">REGION_CODE</div>
                        <div class="text-2xl font-black orbitron">${data.code || 'UKN'}</div>
                    </div>
                `;
                document.getElementById('report-text').innerHTML = `<span>${data.analysis}</span>`;
            } catch (err) {
                document.getElementById('report-text').innerHTML = "<span class='text-red-500'>CRITICAL: CONNECTION TIMEOUT.</span>";
            }
        }

        async function handleOracleKey(e) {
            if (e.key === 'Enter') {
                const prompt = e.target.value;
                if (!prompt) return;
                const box = document.getElementById('oracle-response-box');
                box.innerHTML += `<div class="user-cmd">> ${prompt}</div>`;
                box.innerHTML += `<div id="ai-typing" class="text-cyan-500/40 my-2 text-[10px] font-bold">PROCESSING...</div>`;
                box.scrollTop = box.scrollHeight;
                
                try {
                    const res = await fetch('/api/sybil', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    if(document.getElementById('ai-typing')) document.getElementById('ai-typing').remove();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "NO_RESPONSE.";
                    box.innerHTML += `<div class="ai-msg">${reply}</div>`;
                } catch (err) {
                    if(document.getElementById('ai-typing')) document.getElementById('ai-typing').remove();
                    box.innerHTML += `<div class="text-red-900 font-bold">LINK_FAILURE.</div>`;
                }
                box.scrollTop = box.scrollHeight;
                e.target.value = '';
            }
        }

        function hidePanel() { document.getElementById('info-panel').classList.remove('visible'); }
        window.onload = init;
    </script>
</body>
</html>
